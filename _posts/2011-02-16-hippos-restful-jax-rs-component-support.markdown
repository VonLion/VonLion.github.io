---
layout: post
title: "HIPPOs RESTful JAX-RS Component Support and Spring Android"
date: 2011-02-16
comments: false
categories:
 - java
 - hippo
---

<div class='post'>
The new <a href="http://www.onehippo.com/en/products/cms/try">Hippo CMS 7.5 release</a> brings some quite interesting features. The most interesting new feature for me&nbsp;was&nbsp;support for&nbsp;RESTful components within the Hippo Site Toolkit (HST-2 v2.20.01).&nbsp;Being able to expose data in a RESTful manner opens up a whole new set of possibilities for external application developers.<br /><br />As you might have read in my <a href="http://blog.jeroenreijn.com/2011/02/working-with-android-layouts-and.html">previous post</a>, I'm building a sample application to get acquainted with the Android platform. My previous post was mainly focussed on layouts and ListViews, but this time I will be focussing on information retrieval from an external <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST</a> service. That's why&nbsp;I've used the default REST service that comes with the online&nbsp;<a href="http://www.demo.onehippo.com/">Hippo GoGreen demo</a>&nbsp;as my&nbsp;source of&nbsp;information. &nbsp;The GoGreen REST service exposes a list of 'top products' with additional information about the products that can be used nicely for this demo project, but first let's start at the beginning.<br /><br /><h2>Getting started with&nbsp;RESTful HST-2 components</h2>From what I've seen in the documentation and in the GoGreen source code, there are two different methods of exposing data with the RESTful components.<br /><ol><li>The data can be exposed based on the primary JCR NodeType of a resource inside the Hippo repository. The HST-2 sitemap will determine the URLs of the items based on the relative path of the items inside the repository. This approach can be done with the&nbsp;<span class="Apple-style-span" style="white-space: pre;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JaxrsRestContentPipeline.</span></span></li><li>A sitemap item (or mount) can be configured as a&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JaxrsRestPlainPipeline</span><i>.</i>&nbsp;By doing so, the HST will try to match the request within a <a href="http://en.wikipedia.org/wiki/JAX-RS">Jax-RS</a> based resource provider&nbsp;component that handles all the (relative) URL matching from there on. &nbsp;&nbsp;</li></ol><ul></ul>In this example I will use the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JaxrsRestPlainPipeline</span>&nbsp;approach, which is also used by the Hippo GoGreen demo to create the 'top products' resource. The response output of a REST pipeline can be in all kinds of different formats. For this example we will use <a href="http://en.wikipedia.org/wiki/JSON">JSON</a>, but you can also use XML instead.<br /><br /><h3>Configuration</h3><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">The first step in the proces of setting up our own REST service is to create an HST mount. The configuration for our mount has to look something similar to :</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><pre class="brush:java" style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&lt;sv:node sv:name="restapi"&gt;<br />  &lt;sv:property sv:name="jcr:primaryType" sv:type="Name"&gt;<br />    &lt;sv:value&gt;hst:mount&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:alias" sv:type="String"&gt;<br />    &lt;sv:value&gt;restapi&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:authenticated" sv:type="Boolean"&gt;<br />    &lt;sv:value&gt;false&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:isSite" sv:type="Boolean"&gt;<br />    &lt;sv:value&gt;false&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:mountpoint" sv:type="String"&gt;<br />    &lt;sv:value&gt;/hst:hst/hst:sites/rest-live&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:mountsite" sv:type="String"&gt;<br />    &lt;sv:value&gt;site&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:namedpipeline" sv:type="String"&gt;<br />    &lt;sv:value&gt;JaxrsRestContentPipeline&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:roles" sv:type="String"&gt;<br />    &lt;sv:value&gt;everybody&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:showport" sv:type="Boolean"&gt;<br />    &lt;sv:value&gt;true&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:subjectbasedsession" sv:type="Boolean"&gt;<br />    &lt;sv:value&gt;true&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:types" sv:type="String"&gt;<br />    &lt;sv:value&gt;rest&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />&lt;/sv:node&gt;<br /></pre><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">As you can see there is lot to configure for a mount, but I don not want to go into much detail. The next step is to setup an HST sitemap for this mount. In the configuration above, our mount uses a default namedpipeline of type&nbsp;&nbsp;<span class="Apple-style-span" style="white-space: pre;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JaxrsRestContentPipeline</span></span>&nbsp;, since we want to use a &nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JaxrsRestPlainPipeline</span>, we can override the type of pipeline by specifying the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">hst:namedpipeline</span> property on an HST sitemap item for this mount, for example for the sitemap item called 'topproducts'.</div><br /><pre class="brush:xml">&lt;sv:node sv:name="topproducts"&gt;<br />  &lt;sv:property sv:name="jcr:primaryType" sv:type="Name"&gt;<br />    &lt;sv:value&gt;hst:sitemapitem&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />  &lt;sv:property sv:name="hst:namedpipeline" sv:type="String"&gt;<br />    &lt;sv:value&gt;JaxrsRestPlainPipeline&lt;/sv:value&gt;<br />  &lt;/sv:property&gt;<br />&lt;/sv:node&gt;<br /></pre><br /><h3>Spring Configuration</h3>Now after we stored the HST-2 configuration in the repository, the next step is to register our new component as a plain resource provider in our website Spring configuration. We can do this by creating a file called <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">custom-jaxrs-resources.xml</span> in the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">src/main/resources/META-INF/hst-assembly/overrides/</span> folder of our Hippo site project with the following content.<br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="http://www.springframework.org/schema/beans" <br />       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;<br />  <br />  &lt;import resource="classpath:/org/hippoecm/hst/site/optional/jaxrs/SpringComponentManager-rest-jackson.xml" /&gt;<br />  &lt;import resource="classpath:/org/hippoecm/hst/site/optional/jaxrs/SpringComponentManager-rest-plain-pipeline.xml" /&gt;<br />  &lt;import resource="classpath:/org/hippoecm/hst/site/optional/jaxrs/SpringComponentManager-rest-content-pipeline.xml" /&gt;<br />  <br />  &lt;!-- Custom JAX-RS REST Plain Resource Providers to be overriden. --&gt;<br />  &lt;bean id="customRestPlainResourceProviders" class="org.springframework.beans.factory.config.ListFactoryBean"&gt;<br />    &lt;property name="sourceList"&gt;<br />      &lt;list&gt;<br />        &lt;bean class="org.apache.cxf.jaxrs.lifecycle.SingletonResourceProvider"&gt;<br />          &lt;constructor-arg&gt;<br />            &lt;bean class="com.onehippo.gogreen.jaxrs.services.TopProductsResource" /&gt;<br />          &lt;/constructor-arg&gt;<br />        &lt;/bean&gt;<br />      &lt;/list&gt;<br />    &lt;/property&gt;<br />  &lt;/bean&gt;<br />      <br />&lt;/beans&gt;<br /></pre><br />With this configuration in place the HST-2 has knowledge of our custom resource and the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">TopProductsResource</span>&nbsp;can start creating the response.<br /><br />Now let's take a look at our <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">TopProductsResource</span>.<br /><br /><pre class="brush:java">@Path("/topproducts/") <br />public class TopProductsResource extends AbstractResource {<br />  @GET<br />  @Path("/topproducts/")<br />  public List&lt;ProductLinkRepresentation&gt; getProductResources(@Context HttpServletRequest servletRequest, @Context HttpServletResponse servletResponse, @Context UriInfo uriInfo,<br />            @QueryParam("sortby") @DefaultValue("hippogogreen:rating") String sortBy, <br />            @QueryParam("sortdir") @DefaultValue("descending") String sortDirection,<br />            @QueryParam("max") @DefaultValue("10") String maxParam) {<br />        <br />      List&lt;ProductLinkRepresentation&gt; productRepList = new ArrayList&lt;ProductLinkRepresentation&gt;();<br />      HstRequestContext requestContext = getRequestContext(servletRequest);<br />        <br />      try {<br />          Node mountContentNode = getNodeFromMount(requestContext);<br />          HstQueryResult result = getHstQueryResult(sortBy, sortDirection, maxParam, requestContext, mountContentNode);<br />          HippoBeanIterator iterator = result.getHippoBeans();<br /><br />          while (iterator.hasNext()) {<br />              Product productBean = (Product) iterator.nextHippoBean();<br />                <br />              if (productBean != null) {<br />                ProductLinkRepresentation productRep = new ProductLinkRepresentation(requestContext).represent(productBean);<br />                productRepList.add(productRep);<br />              }<br />          }<br />      } catch (Exception e) {<br />        log.warn("Failed to retrieve top products. {}", e);        <br />        throw new WebApplicationException(e);<br />      }<br />        <br />      return productRepList;<br />  }<br />}<br /></pre><br />The <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">TopProductsResource</span> has a&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">@Path("/topproducts/")</span>&nbsp;annotation set on the class level. This is what's making the request to '/topproducts' being handled by this specific resource. As you can see the only other thing the resource does is perform the query from the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">getProductResources()</span>&nbsp;method. Take a look at the full&nbsp;<a href="http://svn.onehippo.org/repos/hippo/hippo-demos/hippo-go-green/trunk/site/src/main/java/com/onehippo/gogreen/jaxrs/services/TopProductsResource.java">source code</a>&nbsp;for more details on the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">TopProductsResource</span> class.<br /><br /><h3>Response output</h3><br />Now that we've setup the configuration and put the component in place, let's take a look at our actual response.  You can see what the response of the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">TopProductsResource</span>&nbsp;is if you go to the following URL:<br /><code><br />http://www.demo.onehippo.com/restapi/topproducts?_type=json<br /></code><br /><i>Note: the URL might not be available at the time you try it, because the GoGreen demo is restarted every 30 minutes with a fresh set of content. If the URL does not work try again in 5 minutes.</i><br /><br />Since we specified the response type as JSON, the actual response should look something like what is shown below. For readability I've removed some properties, but I guess you get the idea. <br /><br /><pre class="brush:javascript">[<br />  {<br />    productLink: "http://www.demo.onehippo.com/restapi/products/food/2010/07/organic-cotton-reusable-lunch-bag./"<br />    price: 34<br />    rating: 5<br />    smallThumbnail: "http://www.demo.onehippo.com/binaries/smallthumbnail/content/gallery/products/2010/06/organic-lunch-bag.jpg"<br />    localizedName: "Organic Cotton Reusable Lunch Bag"<br />    primaryNodeTypeName: "hippogogreen:product"<br />  },<br />  {<br />    productLink: "http://www.demo.onehippo.com/restapi/products/food/2010/07/birch-wood-compostable-cutlery./"<br />    price: 5<br />    rating: 4.25<br />    smallThumbnail: "http://www.demo.onehippo.com/binaries/smallthumbnail/content/gallery/products/2010/07/wooden-cutlery.png"<br />    localizedName: "Birch Wood Compostable Cutlery"<br />    primaryNodeTypeName: "hippogogreen:product"<br />  }<br />]<br /></pre><br />As you can see the response is quite simple and contains an array of product items with their properties.<br />If you want to know more about RESTful Component support there is a nice <a href="https://wiki.onehippo.com/display/HST2/RESTful+JAX-RS+Component+Support+in+HST-2">page</a> on the HST-2 wiki.&nbsp;Now let's move on with the Android part of this post.<br /><br /><h2>Spring Android</h2>Android version 2.2 has native support for handling JSON. I tried that, but I recently discovered <a href="http://www.springsource.org/spring-android">Spring Android</a>.&nbsp;Spring Android is quite new and gives you an easy to use <a href="http://static.springsource.org/spring-android/docs/1.0.x/reference/html/rest-template.html" target="_blank">REST client</a>. The reason I chose to use Spring Android is that it takes less code to handle requests then by doing it the native Android way with the default HttpClient. Now when we combining Spring Android with <a href="http://jackson.codehaus.org/">Jackson</a>&nbsp;it makes working with JSON really easy. All you have to do is create a mapping class, so that Jackson knows how to map the response array.<br /><br />To be able to work with the JSON response we will need the following three libraries in our Android project.<br /><ul><li>spring-android-rest-template-1.0.0.M2.jar</li><li>jackson-core-asl-1.7.1.jar</li><li>jackson-mapper-asl-1.7.1.jar</li></ul><br /><h3>Using Spring Android</h3><br />For my Android application I've created a service class called <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">ProductService</span>.<br /><br /><pre class="brush:java">public class ProductService {<br />  private static final String RESTAPI_BASE_URI = "http://www.demo.onehippo.com/restapi";<br />  private static final String RESTAPI_RESPONSE_TYPE = "_type=json";<br /><br />  public static ArrayList&lt;Product&gt; getAllProductsFromHippo() {<br />    ArrayList&lt;Product&gt; products = new ArrayList&lt;Product&gt;();<br />    RestTemplate restTemplate = new RestTemplate();<br />    <br />    List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = restTemplate.getMessageConverters();<br />    //add the Jackson mapper for easy mapping of JSON to POJO's<br />    messageConverters.add(new MappingJacksonHttpMessageConverter());<br /><br />    String url = RESTAPI_BASE_URI + "/topproducts./?" + RESTAPI_RESPONSE_TYPE;<br /><br />    Product[] productsFromHippo = restTemplate.getForObject(url, Product[].class);<br />    products.addAll(Arrays.asList(productsFromHippo));<br />    return products;<br />  }<br />}<br /></pre><br />As you can see the&nbsp;<span class="Apple-style-span" style="white-space: pre;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">getAllProductsFromHippo</span></span> method uses the Spring Android&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">RestTemplate</span> in combination with the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">MappingJacksonHttpMessageConverter</span> to map the JSON response to an array of <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Product</span>&nbsp;classes. Let's have a closer look at a <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Product</span>&nbsp;class.<br /><br /><pre class="brush:java">package org.onehippo.gogreen.android.data;<br /><br />import org.codehaus.jackson.annotate.JsonIgnoreProperties;<br />import org.codehaus.jackson.annotate.JsonProperty;<br /><br />@JsonIgnoreProperties(ignoreUnknown = true)<br />public class Product {<br /><br />  @JsonProperty<br />  private String localizedName;<br /><br />  public String getLocalizedName() {<br />      return localizedName;<br />  }<br /><br />  public void setLocalizedName(final String localizedName) {<br />      this.localizedName = localizedName;<br />  }<br />}<br /></pre><a href="http://3.bp.blogspot.com/-rs4t8FsokCc/TVvDXoPj15I/AAAAAAAAAcg/Tp_4bhVK2NM/s1600/android_products_list.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://3.bp.blogspot.com/-rs4t8FsokCc/TVvDXoPj15I/AAAAAAAAAcg/Tp_4bhVK2NM/s320/android_products_list.png" height="320" width="193" /></a><br />The <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Product</span> class is quite simple. It only contains the localized name (for now). To make sure the mapping succeeds, I've also added the annotation <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">JsonIgnoreProperties</span> , so that it will ignore unknown properties during the mapping phase.<br />Now if we provide the list of <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Product</span> items to the Android <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">ArrayAdapter</span>, which is used by our ListView we will see all the items in the list returned by the HST-2 REST service.<br /><br /><h2>Resources used</h2>The following resources were used to create this post:<br /><ul><li><a href="http://svn.onehippo.org/repos/hippo/hippo-demos/hippo-go-green/trunk/">Hippo GoGreen demo source code</a></li><li><a href="http://jackson.codehaus.org/">Jackson (JSON parser)</a></li><li><a href="http://www.springsource.org/spring-android">Spring Android</a></li><li><a href="https://wiki.onehippo.com/display/HST2/RESTful+JAX-RS+Component+Support+in+HST-2">RESTful Jax-RS component support in HST-2</a></li></ul></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Harpreet Singh</div>
<div class='content'>
As you may have noticed that by default hippo login process refreshes the browser 2 times 1st. when it makes hit to proxy/login and again hippo makes hit to the /login/resource.<br />OK If its be fine can I make the changes into /login/resource so that I can add gif image so the user can see :- &quot;you are being loggin to sit&quot; or a loading image <br />-OR-<br />there Is any way through which I can log in through rest service using ajax call ?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Very nice article Reijn. Great stuff! Think we should add it to our documentation as an example :)</div>
</div>
<div class='comment'>
<div class='author'>Woonsan Ko</div>
<div class='content'>
Wow, great article! Thanks for sharing!</div>
</div>
</div>
