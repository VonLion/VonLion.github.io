---
layout: post
title: "Unit testing your HST2 components with EasyMock"
date: 2010-10-21
comments: false
categories:
 - java
 - hippo
---

<div class='post'>
Quality is an important aspect of every software development project. Writing unit tests is just one part of keeping an eye on quality. In this post I will try to explain how you can unit test your <a href="http://www.onehippo.org/site-toolkit/index.html">Hippo Site Toolkit (HST2)</a> components, so you can be sure that the component still behaves as expected even after multiple maintenance cycles.<br /><br /><h2>A mocking framework</h2>Unit testing is the testing of software units (for instance HST2 components) in isolation. However, most units do not work alone, but they collaborate with other units, like the HST2 does for instance with a running JCR repository and a live HttpServletRequest (wrapped inside an HstRequest). To test a unit in isolation, we have to simulate these collaborations in our tests.<br />One way of working around such collaborations is by using Mock objects. A Mock Object is a test-oriented replacement for such a collaborator. It is configured to simulate the object that it replaces in a simple way. For this post I use&nbsp;<a href="http://www.easymock.org/">EasyMock</a>, but there are other mocking frameworks out there.<br /><br /><h2>Setting up your environment</h2>If you are regular reader, you might have noticed that I've been using Maven2 in most of my posts, so this time will not be different. To be able to test your HST components, you will need to add the following dependencies to your project/module pom.xml.<br /><br /><pre class="brush:xml">&lt;dependency&gt;<br />  &lt;groupId&gt;junit&lt;/groupId&gt;<br />  &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />  &lt;version&gt;4.5&lt;/version&gt;<br />  &lt;scope&gt;test&lt;/scope&gt;<br />&lt;/dependency&gt;<br /><br />&lt;dependency&gt;<br />  &lt;groupId&gt;org.easymock&lt;/groupId&gt;<br />  &lt;artifactId&gt;easymock&lt;/artifactId&gt;<br />  &lt;version&gt;2.5.2&lt;/version&gt;<br />  &lt;scope&gt;test&lt;/scope&gt;<br />&lt;/dependency&gt;<br /><br />&lt;dependency&gt;<br />  &lt;groupId&gt;org.easymock&lt;/groupId&gt;<br />  &lt;artifactId&gt;easymockclassextension&lt;/artifactId&gt;<br />  &lt;version&gt;2.5.2&lt;/version&gt;<br />  &lt;scope&gt;test&lt;/scope&gt;<br />  &lt;exclusions&gt;<br />    &lt;exclusion&gt;<br />      &lt;groupId&gt;cglib&lt;/groupId&gt;<br />      &lt;artifactId&gt;cglib-nodep&lt;/artifactId&gt;<br />    &lt;/exclusion&gt;<br />  &lt;/exclusions&gt;<br />&lt;/dependency&gt;<br /><br />&lt;dependency&gt;<br />  &lt;groupId&gt;org.onehippo.cms7.hst&lt;/groupId&gt;<br />  &lt;artifactId&gt;hst-mock&lt;/artifactId&gt;<br />  &lt;scope&gt;test&lt;/scope&gt;<br />&lt;/dependency&gt;<br /><br /></pre><br />Now that we have setup all the needed dependencies let's create an HST component to get started.<br /><br /><h2>Basic HST2 Component</h2><br />So let's start of with a simple/basic HST2 component. Here we have a simple component that tries to get a HippoBean wrapping a JCR node for the current request and puts the bean as an attribute on the request.<br /><br /><pre class="brush:java">import org.hippoecm.hst.component.support.bean.BaseHstComponent;<br />import org.hippoecm.hst.content.beans.standard.HippoBean;<br />import org.hippoecm.hst.core.component.HstComponentException;<br />import org.hippoecm.hst.core.component.HstRequest;<br />import org.hippoecm.hst.core.component.HstResponse;<br /><br />public class AbstractBaseHstComponent extends BaseHstComponent{<br /><br />    @Override<br />    public void doBeforeRender(HstRequest request, HstResponse response) <br />        throws HstComponentException {<br /><br />        HippoBean bean = getContentBean(request);<br />        if(bean!=null) {<br />            request.setAttribute("document",bean);<br />        }<br />    }<br />}<br /></pre><br />Looks quite simple right? Now let's move on to the test.<br /><br /><h2>The actual test</h2>Now that we've seen what our component looks like, let's take a look at how we can test this class. The component doesn't do a lot, but there are a couple of things that we want to test:<br /><br /><ul><li>that the getContentBean method is called</li><li>when the bean is not null the bean is set as an attribute on the request</li><li>there is an attribute on the request with the name document</li><li>the document from the request attribute is the same as the one put on the request</li></ul><br />So now let's translate that into some code.<br /><br />Before we can actually test our doBeforeRender method we need to do some setup before we can continue.<br /><br /><pre class="brush:java">MockHstRequest fakeRequest;<br />MockHstResponse fakeResponse;<br />AbstractBaseHstComponent component;<br /><br />@Before<br />public void setUp() throws Exception {<br />    fakeRequest = new MockHstRequest();<br />    fakeResponse = new MockHstResponse();<br />    component = createMockBuilder(AbstractBaseHstComponent.class).<br />                addMockedMethod("getContentBean", HstRequest.class).<br />                createMock();<br />}<br /></pre><br />Now looking at this setUp() method, you will notice that at first we create mocked versions of a request and response. These objects are necessary because they are parameters for our method under test. In a normal environment these objects will be created by the servlet container, but since we're unit testing we have to create these ourselves.  <br /><br />Next to that we create a mocked version of our AbstractBaseHstComponent. We do this because we need to mock the getContentBean method, which in a normal live environment performs interaction to a live JCR repository. The logic for getting the bean based on repository configuration is not useful for our test, so we mock the method and create a partial mock of the class.<br /><br />Now let's have a look at the total test case and the actual test method.<br /><br /><pre class="brush:java">import org.hippoecm.hst.content.beans.standard.HippoBean;<br />import org.hippoecm.hst.content.beans.standard.HippoDocument;<br />import org.hippoecm.hst.core.component.HstRequest;<br />import org.junit.Before;<br />import org.junit.Test;<br />import org.hippoecm.hst.mock.core.component.MockHstRequest;<br />import org.hippoecm.hst.mock.core.component.MockHstResponse;<br />import static org.easymock.classextension.EasyMock.*;<br />import static org.junit.Assert.*;<br /><br />/**<br /> * Test for {@link com.jeroenreijn.site.components.AbstractBaseHstComponent}<br /> */<br />public class AbstractBaseHstComponentTest {<br /><br />    MockHstRequest fakeRequest;<br />    MockHstResponse fakeResponse;<br />    AbstractBaseHstComponent component;<br /><br />    @Before<br />    public void setUp() throws Exception {<br />        fakeRequest = new MockHstRequest();<br />        fakeResponse = new MockHstResponse();<br />        component = createMockBuilder(AbstractBaseHstComponent.class).<br />                addMockedMethod("getContentBean", HstRequest.class).<br />                createMock();<br />    }<br /><br />    @Test<br />    public void testDocumentOnRequestAfterDoBeforeRender() throws Exception {<br /><br />        HippoBean bean = new HippoDocument();<br /><br />        //record the expected behavior<br />        expect(component.getContentBean(fakeRequest)).andReturn(bean);<br /><br />        //stop recording and switch the mocked Object to replay state.<br />        replay(component);<br /><br />        component.doBeforeRender(fakeRequest,fakeResponse);<br /><br />        //verify the specified behavior has been used<br />        verify(component);<br /><br />        assertSame(fakeRequest.getAttribute("document"),bean);<br />    }<br />}<br /><br /></pre><br />As you might notice, the testDocumentOnRequestAfterDoBeforeRender() method tests the doBeforeRender method and checks all of the above requirements.<br /><br /><h2>The next step</h2><br />Even though you can create a mock of most objects quite easily, it's much better to have some native support/provided mock objects for most HST2 classes. Therefore I've added a <a href="https://issues.onehippo.com/browse/HSTTWO-1257">patch to JIRA</a>, which adds more mocked classes that can be used for testing, so you do not have to mock explicit methods. Next to that it will create test maven artifact, which you can use when testing your HST component without having to mock explicit methods or objects yourself.<br />Let me know if you run into any issues or have some ideas on improvement. It can make all our lives better.<br /><br /><i>Note/Update: This post was written at a time when the mock  classes were not part of Hippo core (version 7.4). In the meantime this has changed  and the classes can now be found in hst-mock artifact.</i> <br /><br /><br />ps. I've just noticed that Shane Smith of iProfs created a <a href="http://blog.iprofs.nl/2010/10/19/hst-and-mockito-sitting-on-a-tree/">similar post</a> with using <a href="http://mockito.org/">Mockito</a>.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Jeroen Reijn</div>
<div class='content'>
Hi Frédérick, <br /><br />as far as I know there is no real documentation available, but I have not checked in a while. The best approach would be to send an email with the same content as posted above to the Hippo user-list/forum. I know that Ard and Woonsan (core HST developers) are very active and if there is any documentation or examples they will be the ones that can lead you to it.<br /><br />Regards,<br /><br />Jeroen</div>
</div>
<div class='comment'>
<div class='author'>Frédérick Verbist</div>
<div class='content'>
Hi,<br /><br />nice article.<br /><br />do you know of any documentation about doing integration testing of hippo components ?<br />I&#39;ve seen posts about using Selenium, but what I&#39;m after is a way to create my data programmatically in the hippo repository and test components that are accessing it to validate the queries i.e.<br /><br />About the same way I would have integration tests for my DAO layer in a &#39;classic&#39;  webapp project.<br /><br />thanks</div>
</div>
<div class='comment'>
<div class='author'>Jeroen Reijn</div>
<div class='content'>
As an addition you could also use a build-in feature of EasyMock, but doing it like this:<br /><br />HstResponse responseMock = createMock(HstResponse.class);<br /><br />that will also give you a mocked HstResponse.</div>
</div>
<div class='comment'>
<div class='author'>Jeroen Reijn</div>
<div class='content'>
Hi Dave,<br /><br />it seems you are right. Somehow the MockHstResponse did not make it into the HST. I&#39;ll track down to see why and will post a reply here if that&#39;s ok with you.</div>
</div>
<div class='comment'>
<div class='author'>Dave Clayton</div>
<div class='content'>
Hi there,<br /><br />I&#39;m trying to write unit tests for our Hippo components but can&#39;t seem to find the MockHstResponse class anywhere. It seems that this dependency:<br /><br />  <br />   org.onehippo.cms7.hst<br />   hst-mock<br />  <br /><br />Gives me the MockHstRequest class but not the response. Any ideas what to do here?</div>
</div>
</div>
