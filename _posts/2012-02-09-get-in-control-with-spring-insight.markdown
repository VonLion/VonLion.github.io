---
layout: post
title: "Get in control with Spring Insight!"
date: 2012-02-09
comments: false
categories:
 - spring
 - hippo
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-0PN-ehj_nQ4/TzQz3WID_6I/AAAAAAAAAhU/vMD-iMenY68/s1600/SpringInsight_Logo_black_0.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="90" src="http://3.bp.blogspot.com/-0PN-ehj_nQ4/TzQz3WID_6I/AAAAAAAAAhU/vMD-iMenY68/s320/SpringInsight_Logo_black_0.png" width="320" /></a></div>Ever wondered what your application was doing? Why that specific page was so slow? I've asked myself this question numerous times and always had to change some log level or attach a profiler to get actual feedback on what was going on inside my application.<br /><br />The other day while commuting from home to work, I discovered the <a href="http://www.springsource.org/insight/">Spring Insight project</a>. From what I've seen so far Spring Insight is a set of inspections (plugins) which are visually displayed in a web application. To get an idea of what Spring Insight can do for you, be sure to check out the introduction screencast.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://s3.springsource.com/MRKT/spring-metrics/Spring_Insight-1.0.0.RELEASE_screencast.mov" style="margin-left: 1em; margin-right: 1em;"><img alt="tc Server Developer Edition Screencast" src="http://springsource.com/files/uploads/all/images/product/scrThumb_Demo_Insight.png" /></a></div><br /><br />By default Spring Insight comes with a default set of plugins/inspections for different kinds of frameworks/libraries like:<br /><ul><li>Spring Web, Spring&nbsp;core</li><li>JDBC</li><li>Servlets</li><li>Hibernate</li><li>Grails</li></ul><div>There are <a href="https://github.com/SpringSource/spring-insight-plugins/tree/master/collection-plugins" target="_blank">more plugins available</a> and it's even quite easy to create some of your own and that's what the rest of this post is about.</div><div><br /></div><div><span style="font-size: large;">Writing your own Spring Insight plugin</span></div><div><br /></div><div>Working with Hippo CMS driven web applications every day I had the idea of creating a Spring Insight plugin for the Hippo Site Toolkit (HST in short). The HST consists of a set of components that interact with the Hippo content repository. During a single request multiple components can be called and for each component there are multiple processing phases. So my initial idea for the Spring Insight plugin was to&nbsp;show:</div><div><ol><li>The amount of time taken for each processing phase of an HST component</li><li>The time it takes to perform an <i>HstQuery</i> to the repository</li></ol><div>Because the default Spring Insight plugins are open source I was able to write my first plugin in about 30 minutes or so. A large part of those 30 minutes were taken up with learning&nbsp;<a href="http://eclipse.org/aspectj/">AspectsJ</a>, because I'd never used that before.<br /><br /><span style="font-size: large;">Getting started</span><br /><br />For this post we will now focus on creating an inspection on performing HST queries. From the Insight web application view I would like to see the information&nbsp; of an <i>HstQuery</i> and time it took to perform the actual query.<br />With AspectJ you can pick a join point and inspect for instance the execution of that join point. In our case I would like to inspect the <i>HstQuery.execute()</i> method. By putting the join point on the <i>HstQuery</i> interface, we've made sure that any object extending the <i>HstQuery</i> will be able to represent it's data within the Insight web application.<br /><br />Let's first take a look at the what such an inspection looks like. <br /><br /><br /><pre class="brush:java">package com.jeroenreijn.insight.hst;<br /><br />import com.springsource.insight.collection.AbstractOperationCollectionAspect;<br />import com.springsource.insight.intercept.operation.Operation;<br />import com.springsource.insight.intercept.operation.OperationType;<br /><br />import org.aspectj.lang.JoinPoint;<br />import org.hippoecm.hst.content.beans.query.HstQuery;<br />import org.hippoecm.hst.content.beans.query.HstQueryResult;<br />import org.hippoecm.hst.content.beans.query.exceptions.QueryException;<br /><br />/**<br /> * Aspect for collecting HstQuery executions.<br /> */<br />public aspect HstQueryOperationAspect extends AbstractOperationCollectionAspect {<br /><br />    private static final OperationType TYPE = OperationType.valueOf("query_execute");<br /><br />    public pointcut collectionPoint(): execution(HstQueryResult HstQuery.execute());<br /><br />    public Operation createOperation(JoinPoint jp) {<br />        HstQuery query = (HstQuery) jp.getTarget();<br />        Operation op = new Operation()<br />                .type(TYPE)<br />                .label("HstQuery");<br />        op.sourceCodeLocation(getSourceCodeLocation(jp));<br />        try {<br />            op.put("query", query.getQueryAsString(false));<br />            op.put("limit", query.getLimit());<br />            op.put("offset", query.getOffset());<br />        } catch (QueryException e) {<br />            // ignore for now<br />        }<br />        return op;<br />    }<br /><br />}</pre><br />The more important part of the above collection aspect is the <i>collectionPoint</i> poincut, where we define what kind of operation we would like to collect information from. In this case we define an inspection on the <i>HstQuery.execute()</i> method.<br />Next to the collection point you will also see the <i>createOperation()&nbsp; </i>method. which allows you to collect certain information from the current state of the collection point<i>. </i>In the above code snippet we collect the actually <i>HstQuery</i> object and get some information from it like the actual JCR XPath query, the limit set on the query and the offset.&nbsp; That's all for the information collection part of our plugin.<br /><br />Now that we've created the aspect for the <i>HstQuery</i>, let's create a view for this inspection. You can create a freemarker template for each inspection if you want. For the <i>HstQuery</i> I've created the following template.<br /><br /><pre class="brush:xml">&lt;#ftl strip_whitespace=true&gt;<br />&lt;#import "/insight-1.0.ftl" as insight /&gt;<br /><br />&lt;@insight.group label="HST Query"&gt;<br />    &lt;@insight.entry name="Query" value=operation.query /&gt;<br />    &lt;@insight.entry name="Limit" value=operation.limit /&gt;<br />    &lt;@insight.entry name="Offset" value=operation.offset/&gt;<br />&lt;/@insight.group&gt;<br /></pre><br />In the above template we define the values that we've put as attributes on our <i>Operation</i> object. All we have to do now is wire the operation and the view together inside the plugin configuration.<br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="http://www.springframework.org/schema/beans"<br /> xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br /> xmlns:insight="http://www.springframework.org/schema/insight-idk"<br /> xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd<br />  http://www.springframework.org/schema/insight-idk http://www.springframework.org/schema/insight-idk/insight-idk-1.0.xsd"&gt;<br /><br />&lt;insight:plugin name="hst" version="${project.version}" publisher="Jeroen Reijn" /&gt;<br /><br />  &lt;insight:operation-view operation="query_execute" template="com/jeroenreijn/insight/hst/query.ftl" /&gt;<br /><br />  &lt;insight:operation-group group="Hippo" operation="query_execute" /&gt;<br /><br />&lt;/beans&gt;<br /></pre><div><br /><br />So now that we've finished our plugin, we package it and drop it inside the <i>collection-plugins</i> folder of our Spring Insight instance. Next we fire up the <a href="http://www.vmware.com/products/vfabric-tcserver/">VMware vFabric TM  tc Server</a> and do some requests on the web application that we would like to get some information from. Once that's done switch the URL in the browser to '/insight' and there is the information collected by Spring Insight. The image below show exactly the information that we tried to show.<br /><br /></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-SEC9RgyMLuc/Tp0MlDXYjNI/AAAAAAAAAgA/GOv2q70Opw8/s1600/CapturFiles-201110287_1210.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="355" src="http://3.bp.blogspot.com/-SEC9RgyMLuc/Tp0MlDXYjNI/AAAAAAAAAgA/GOv2q70Opw8/s640/CapturFiles-201110287_1210.png" width="640" /></a></div><br /></div><div><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">In this example request you can see from the top of the call stack, the chain of filters that the request went through and all of the HST components. For each component you can now see the class, the window name (as you can also see in the CMS console) and the render path ( the JSP or Freemarker template) used for rendering the information of the component. You can also expand an HST component when it contains an <i>HstQuery</i>.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br />The advantage of having such a plugin might help us identify some slow pages that might have slow JCR queries or components that do extensive (unnecessary) processing.<br /><br /><span style="font-size: large;">Summary</span><br /><br />Spring Insight is a very interesting project. Doing a quick scan for troublesome code is relatively fast, but can for now only be done with the VMware vFabric TM  tc Server, so you cannot run it in your personal preferred application container like Tomcat, Jetty or JBoss. I've personally added Spring Insight to my default set of tools for figuring out performance issues when I need to do a review of a project.<br /><br />All of the above code and how to install this HST Spring Insight plugin can be found on the <a href="https://github.com/jreijn/insight-plugin-hst" target="_blank">plugin project page on Github</a>.</div></div></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Jeroen Reijn</div>
<div class='content'>
Hi Anuj.<br /><br />I looked at this as well, but currently (unless it has changes over the last months) this is not possible. They make use of some additional features of the VMware vFabric TM tc Server (which is tomcat on steriods). The additional features (like classloading, etc) of the vFabric server makes Spring insight such a nice tool.<br /><br />Sorry I cannot help.<br /><br />Jeroen</div>
</div>
<div class='comment'>
<div class='author'>Anuj</div>
<div class='content'>
Hey Jeroen,<br />Do you know how I can integrate Spring Insight with plain vanila tomcat 6.x ? <br />I know that Spring Insight talks about its support for tomcat but I am not able to find a single place of documentation of how I can do it?<br /><br />If you could point me to some page that talks abouot it or can provide me some pointers that would be really helpful.<br /><br />Cheers!<br />Anuj</div>
</div>
<div class='comment'>
<div class='author'>Jeroen Reijn</div>
<div class='content'>
Hi Tal,<br /><br />thank you for visiting and for this great offer. I&#39;ll see if I can polish the plugin a bit more and will send a pull request when I&#39;m done if that&#39;s OK with you?<br /><br />Cheers,<br /><br />Jeroen</div>
</div>
<div class='comment'>
<div class='author'>Tal</div>
<div class='content'>
Hi Jeroen / Jettro,<br />I&#39;m from the Spring Insight team. Nice to see people writing plugins for Insight.<br />If you&#39;d like we can add your plugins to the insight plugins opensource project.</div>
</div>
<div class='comment'>
<div class='author'>Jettro Coenradie</div>
<div class='content'>
Nice one, we have created a plugin for the axon framework as well. Will have a look at your implementation on our hippo projects</div>
</div>
</div>
